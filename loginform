package com.fams;

import com.fams.db.DBConnection;
import com.fams.model.AccountHolder;
import com.fams.service.AuthService;
import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.sql.*;

public class LoginForm extends JFrame {

    private JTextField txtUsername;
    private JPasswordField txtPassword;
    private JComboBox<String> cmbRole;
    private JButton btnLogin, btnExit;
    private AuthService authService = new AuthService();  // Professional login

    public LoginForm() {
        initializeLookAndFeel();
        initializeFrame();
        createDivineUI();
        setVisible(true);
    }

    private void initializeLookAndFeel() {
        try {
            for (UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (Exception ex) {}
    }

    private void initializeFrame() {
        setTitle("FAMS - Divine Login");
        setSize(580, 720);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setResizable(false);

        Image icon = loadImage("/icons/bank.png");
        if (icon != null) setIconImage(icon);
    }

    private void createDivineUI() {
        JPanel mainPanel = new JPanel() {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                GradientPaint gp = new GradientPaint(0, 0, new Color(20, 35, 90),
                        0, getHeight(), new Color(5, 10, 40));
                g2d.setPaint(gp);
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 25, 25);
                g2d.dispose();
            }
        };
        mainPanel.setLayout(null);

        // Title
        JLabel lblTitle = new JLabel("FINANCE ANALYTICS");
        lblTitle.setFont(new Font("Arial Black", Font.BOLD, 28));
        lblTitle.setForeground(Color.CYAN);
        lblTitle.setBounds(0, 50, 580, 60);
        lblTitle.setHorizontalAlignment(SwingConstants.CENTER);
        mainPanel.add(lblTitle);

        JLabel lblSubtitle = new JLabel("Management System");
        lblSubtitle.setFont(new Font("Segoe UI", Font.PLAIN, 20));
        lblSubtitle.setForeground(Color.LIGHT_GRAY);
        lblSubtitle.setBounds(0, 100, 580, 40);
        lblSubtitle.setHorizontalAlignment(SwingConstants.CENTER);
        mainPanel.add(lblSubtitle);

        // Icon
        Image img = loadImage("/icons/login-divine.png");
        JLabel lblIcon = new JLabel();
        if (img != null) {
            lblIcon.setIcon(new ImageIcon(img.getScaledInstance(120, 120, Image.SCALE_SMOOTH)));
        } else {
            lblIcon.setText("DIVINE");
            lblIcon.setFont(new Font("Arial Black", Font.BOLD, 36));
            lblIcon.setForeground(Color.CYAN);
        }
        lblIcon.setBounds(230, 140, 120, 120);
        lblIcon.setHorizontalAlignment(SwingConstants.CENTER);
        mainPanel.add(lblIcon);

        // Form Panel
        JPanel formPanel = new JPanel();
        formPanel.setLayout(null);
        formPanel.setBounds(90, 290, 400, 240);
        formPanel.setBackground(new Color(255, 255, 255, 30));
        formPanel.setBorder(BorderFactory.createLineBorder(new Color(100, 200, 255), 3, true));

        // Role
        JLabel lblRole = new JLabel("Role:");
        lblRole.setForeground(Color.WHITE);
        lblRole.setFont(new Font("Segoe UI", Font.BOLD, 15));
        lblRole.setBounds(50, 20, 80, 30);
        formPanel.add(lblRole);

        String[] roles = {"Admin", "Manager", "User"};
        cmbRole = new JComboBox<>(roles);
        cmbRole.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        cmbRole.setBounds(140, 20, 210, 35);
        formPanel.add(cmbRole);

        // Username
        JLabel lblUser = new JLabel("Username:");
        lblUser.setForeground(Color.WHITE);
        lblUser.setFont(new Font("Segoe UI", Font.BOLD, 15));
        lblUser.setBounds(50, 70, 100, 30);
        formPanel.add(lblUser);

        txtUsername = new JTextField();
        txtUsername.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        txtUsername.setBounds(140, 70, 210, 40);
        txtUsername.setBorder(BorderFactory.createLineBorder(new Color(100, 180, 255), 2));
        formPanel.add(txtUsername);

        // Password
        JLabel lblPass = new JLabel("Password:");
        lblPass.setForeground(Color.WHITE);
        lblPass.setFont(new Font("Segoe UI", Font.BOLD, 15));
        lblPass.setBounds(50, 120, 100, 30);
        formPanel.add(lblPass);

        txtPassword = new JPasswordField();
        txtPassword.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        txtPassword.setBounds(140, 120, 210, 40);
        txtPassword.setBorder(BorderFactory.createLineBorder(new Color(100, 180, 255), 2));
        formPanel.add(txtPassword);

        // Buttons
        btnLogin = createDivineButton("LOGIN", new Color(0, 180, 255), "/icons/login.png");
        btnLogin.setBounds(50, 180, 140, 50);
        formPanel.add(btnLogin);

        btnExit = createDivineButton("EXIT", new Color(255, 80, 80), "/icons/exit.png");
        btnExit.setBounds(210, 180, 140, 50);
        formPanel.add(btnExit);

        mainPanel.add(formPanel);

        // Footer
        JLabel footer = new JLabel("© 2025 Divine Project • All Rights Reserved", SwingConstants.CENTER);
        footer.setForeground(Color.GRAY);
        footer.setFont(new Font("Tahoma", Font.ITALIC, 12));
        footer.setBounds(0, 640, 580, 30);
        mainPanel.add(footer);

        add(mainPanel);

        // Action Listeners
        btnLogin.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                performLogin();
            }
        });

        btnExit.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                System.exit(0);
            }
        });

        txtPassword.addKeyListener(new KeyAdapter() {
            public void keyPressed(KeyEvent e) {
                if (e.getKeyCode() == KeyEvent.VK_ENTER) {
                    performLogin();
                }
            }
        });
    }

    private Image loadImage(String path) {
        try {
            java.net.URL url = getClass().getResource(path);
            if (url != null) {
                return new ImageIcon(url).getImage();
            }
        } catch (Exception e) {}
        return null;
    }

    private JButton createDivineButton(String text, Color bg, String iconPath) {
        JButton btn = new JButton(text);
        btn.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btn.setForeground(Color.WHITE);
        btn.setBackground(bg);
        btn.setFocusPainted(false);
        btn.setBorderPainted(false);
        btn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        Image img = loadImage(iconPath);
        if (img != null) {
            btn.setIcon(new ImageIcon(img.getScaledInstance(24, 24, Image.SCALE_SMOOTH)));
        }
        return btn;
    }

    // PROFESSIONAL LOGIN USING AuthService
    private void performLogin() {
        String username = txtUsername.getText().trim();
        String password = new String(txtPassword.getPassword());
        String role = (String) cmbRole.getSelectedItem();

        if (username.isEmpty() || password.isEmpty()) {
            JOptionPane.showMessageDialog(this,
                "<html><h3><font color=#FF5555>Please enter username and password!</font></h3></html>",
                "Input Required", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Use AuthService (real DAO + validation)
        AccountHolder user = authService.login(username, password, role);

        if (user != null) {
            JOptionPane.showMessageDialog(this,
                "<html><h2>Welcome back,</h2><h1><font color=#00FFFF>" + user.getFullName() + 
                "</font></h1><p>Role: <b>" + user.getRole() + "</b></p></html>",
                "Login Successful", JOptionPane.INFORMATION_MESSAGE);

            dispose();
            new MainApp(user).setVisible(true);  // PASS FULL USER OBJECT
        } else {
            JOptionPane.showMessageDialog(this,
                "<html><h3><font color=#FF3333>Invalid username, password, or role!</font></h3></html>",
                "Access Denied", JOptionPane.ERROR_MESSAGE);
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(new Runnable() {
            public void run() {
                new LoginForm();
            }
        });
    }
}
